<HTML>
<HEAD>
  <TITLE>Expand Stroke Facility</TITLE>
  <LINK REL="icon" href="fftype16.png">
  <LINK REL="stylesheet" TYPE="text/css" HREF="FontForge.css">
</HEAD>
<BODY>
<DIV id="in">

<H1 Style="text-align:center"> Expand Stroke Facility </H1>

<P> The Expand Stroke facility traces a closed, convex contour (referred to as
the "nib") along a "source" contour, producing a new contour or contours that
enclose the area the nib "passed over". When the source contour is open the
result is usually a single closed contour, and when the source contour is
closed the result is usually two closed contours:

<P> However, there are exceptions when the geometry of the nib and the source
contour interact:

<P> The "Expand Stroke..." dialog in the "Element" menu of a font view or
outline view window is the primary interactive interface for the facility.  In
the font view it traces all foreground contours in all selected glyphs.  In the
outline view it traces all contours with at least one point selected, or every
contour if no points are selected on any contour.  The dialog looks like this:

<P> The <A HREF="charview.html#freehand">Freehand Tool</A> also uses the
facility and has a similar dialog, and there are interfaces for both
<A HREF="python.html#glyph-stroke">Python</A> and
<A HREF="scripting-alpha.html#ExpandStroke">the native scripting language</A>.

<P> This guide is arranged into these sections. The
<A HREF="#offsetting">first section</A> discusses the common case of tracing
a circular nib, which is also called "offsetting". It includes a description
of the "<A HREF="#cap">cap</A>" and "<A HREF="#join">join</A>" options for
offset curves.

<P> The <A HREF="#nibs">second section</A> introduces the other nibs types: the
rectangular "calligraphic" nibs associated with some types of calligraphy,
elliptical nibs, and general convex nibs designed by the user.  All nibs
support the same cap and join options listed in the first section, but some
have slightly different behaviors and effects.

<P> The <A HREF="#parameters">last section</A> discusses additional parameters
that address special cases, influence the geometric accuracy of the generated
contours, or that can aid in debugging potential problems.

<H2 id="offsetting">Offsetting</H2>

Tracing a contour with a circular nib of radius <em>r</em> is equivalent to
"offsetting"—creating parallel contours on each side at distance <em>r</em> for
a total line thickness of <em>2r</em>:

<P> In FontForge you specify a circular nib in the UI dialog by choosing the
"Circular/Elliptical" nib type and making the Major and Minor Axis lengths
equal. In the native and Python API a Minor Axis value of zero will be
replaced by the Major Axis value. Although it does not make a geometric
difference, the recommended Nib Angle for Circular nibs is zero:

<P> Offsetting is a longstanding way of specifying a line of fixed thickness in
terms of a contour—that is, a sequence of connecting splines—combined with an
offset radius. The model was common in PostScript and is currently used in the
SVG graphics markup language.  Most font formats do not support offset curves
directly, however, so any line specified that way must be "translated" into
(roughly) equivalent closed contours. This is a common use of the Expand Stroke
facility.

<P> The parallel lines determined by the contour and offset radius alone will
not necessarily connect. They will all connect in the case of a source contour
that is closed and has only "smooth" points:

<P> They will not connect where the source contour is open or has "corner"
points where the angle changes:

<H3 id="cap">Caps</H3>

The line that closes the gap between the offset lines traced to the end of of
an open source contour is called a "cap". PostScript and SVG specify three cap
styles that are really two styles: "Round" and "Butt"/"Square".  A Round cap
connects the ends with a semi-circle, while a Butt cap connects them with a
straight line. When tracing with a circular nib, the FontForge cap options
"Nib" and "Round" are both equivalent to PS/SVG "Round", and the options "Butt"
and "Bevel" are both equivalent to PS/SVG "Butt". (These options differ when
used with other nib shapes.)

<P> A PS/SVG "Square" cap is a Butt cap extended by the length of the offset
radius, and therefore half the width of the traced line. The FontForge "Extend
Cap" parameter generalizes this feature by allowing the user to specify the
distance between the end of the source contour and the cap line either as an
absolute length or in units of half-stroke-width. The parameter works with the
"Round" and "Butt" cap styles but not the "Nib" and "Bevel" styles. A PS/SVG
Square cap is therefore equivalent to a Butt cap with "Extend Cap" set to 1 in
half-stroke-width units.

<H3 id="join">Joins</H3>

When the source contour has a "corner" point with an angle change there will be
one angle of less than 180 degrees and one greater than 180 degrees. The offset
lines on the side with the smaller angle will intersect, and the easy solution
is to trim off the parts of the line past the intersection:

<P> The offset lines at the larger "reflex" angle do not meet. The line closing
the gap between those is called a "join".  PostScript specified three join
styles: "Round", "Bevel" and "Miter". SVG 2.0 adds styles "Miter Clip" and
"Arcs".  FontForge currently supports the four styles "Nib", "Bevel", "Miter",
and "Miter Clip". (There are future plans to support the two additional styles
"Round" and "Arcs".)

<P> A PS/SVG "Bevel" join connects the two offset curves with a straight line,
and this is also what FontForge's "Bevel" option does.  A PS/SVG "Miter" or SVG
"Miter Clip" join (normally) extends each offset curve with a straight line
tangent to the curve at the endpoint to where each intersects, as do
FontForge's equivalent "Miter" and "Miter Clip" options. A FontForge "Nib"
join connects the offset curves with an edge corresponding to the shape of the
nib; when using a round nib this is equivalent to the PS/SVG "Round" join
option, which connects the offset lines with an arc of the offset radius:

<P> The difference between Miter and Miter Clip is in how "long" joins are
handled. The "Join Limit" parameter specifies the maximum "length" of a miter
join.  This limit can be specified either in em-units or (when the nib is
circular) in offset radii. The term "join length" is a bit misleading because
the limit is actually calculated based on the angle of the join, and the
"length" is how long the join <em>would</em> be if the offset curves were
straight lines.  There is a more complete explanation in the
<A HREF="https://www.w3.org/TR/SVG2/painting.html#LineJoin"><CODE>stroke-miterlimit"</CODE>
section of the SVG specification</A>.  With the Miter style a join that
exceeds the join limit "falls back" to a Bevel join, while with the Miter Clip
such a join is clipped at the join limit by a line parallel to the Bevel line:

<P> Note, however, that the term "limit" is also somewhat misleading, in that
a Miter join is <em>never</em> shortened past the Bevel line, which therefore
restricts the minimum length of a given join.

<P> (The FontForge "Round" join option is not yet enabled because round joins
have not yet been generalized to other nib shapes.  The "Arcs" join style will
be documented when it is implemented.)

<H2 id="nibs">Calligraphic and Other Convex Nibs</H2>

<P> In addition to circular nibs the Expand Stroke facility also has
parameterized support for "Calligraphic" (rectangular) and Elliptical nibs.
These nibs are described by Width and Height (called the Major and Minor
Axes in the case of an ellipse) and a rotation Angle:

<H3>General convex nibs</H3>

<P> In contrast with the parameterized nibs, the shape of a Convex nib is
specified as a contour which can be edited interactively in the area at the top
of the dialog, created elsewhere and then pasted into that area, or set via the
Python API. As the name implies the shape enclosed by the contour must be
<em>convex</em>. Formally, a shape is convex when the line between any two
points on the edge of or inside the shape does not pass through any points
<em>not</em> inside the shape (or, if both points are chosen from the same
linear edge, only passes through points also on that edge). Less formally,
a shape is convex when no edges are concave or "indented".

<P> While these definitions may help, it is probably more useful to focus on
the specific criteria used by the facility to verify that a contour is convex.
These criteria are slightly conservative, in that some geometrically convex
contours fail to meet them. (Such cases are rare in practice, and can anyway
often be "repaired" by adding some points without (visibly) changing the
shape.) Note that these criteria apply to a cubic contour.  Although you can
design a nib as a quadratic or spiro contour, it will be converted to a cubic
contour prior to use and any problems will be specified in terms of its cubic
variant.

<P> There are two groups of criteria.  The first group restrict the relative
positions of <em>on-curve</em> points. The points must be arranged as a
<em>convex polygon</em>, which is a non-self-intersecting (i.e.  "simple")
polygon of at least 3 points/edges, where all interior angles at the points are
less than 180 degrees.  These points must be in the form of a closed,
<em>clockwise</em> contour:

<P> The second group of criteria restrict the relative positions of the control
points:

<OL>
  <LI> Each spline must either be a line with <em>no control points</em>,
       or have two control points positioned outside of the convex polygon.
       That means they can not be either inside the polygon or on the edge of
       the polygon.
 <LI> The angle between the on-curve line and the control point line is
      limited by the angle to that point's other control point. Or, if the
      adjacent "edge" is a line, the angle to the next on-curve point.
 <LI> The control point <em>line segment</em> must not intersect the spline's
      other control point <em>line</em>.
</OL>

<P> These criteria typically define a triangle (with one excluded edge) where
one control point can be positioned given the positions of the other points.
In some cases they define an unbounded region:

<H3>Caps and Joins With Other Nibs</H3>

<P> Earlier versions of FontForge only provided cap and join options for
circular and elliptical nibs (some of the latter were misleadingly named).  For
other nibs it automatically closed the cap and join edges with the nib
shape—equivalent to the current "Nib" cap and join styles.  Given that the Nib
options produce the shape that would be created by inking and tracing the nib
on paper, "Nib" is a good default choice.

<P> All cap and join options now work with all nibs, although some work
differently with different nib types. In general you can choose a style
based on how it looks when offsetting. To understand why a given cap or
join has the appearance it does, the rest of this section outlines the
differences.

<P> When tracing with a circular nib, the ends of the offset curves at a join
are always the same distance from the source contour point. This is not true
for other nibs. The difference lead to unexpected results with Bevel and
clipped Miter Clip joins, although both are constructed according to the same
rules.

<P> With any nib the tangent angle at the end of the left and right trace lines
will be the same as the tangent angle at the end of an open source contour.
When tracing with a circular nib the ends of the offset curves at a cap are
also colinear with the end of the source contour. As a result a
(non-extended) Butt cap will intersect all three points, and the semicircle
of a round cap can just be drawn directly from one trace line to the other.
With other nibs many different combinations of ending position are possible.

<P> In order to make a Butt or Round cap in these cases FontForge never trims
a trace line; instead it extends one of the lines to match the other. This
means that Butt and Round caps often extend past the end of the source contour,
with a distance that depends on the nib shape and the cap angle. If this is
a problem the Extend Cap option provides one easy solution. The extension
length is always measured from the end of the source contour, so higher
values will tend to even out the lengths. At some value (that depends on the
nib geometry) all cap distances will be the same.

<P> The Bevel cap option just draws a line between the ends of the two
trace lines. With non-circular nibs the line will not generally be
perpendicular to the tangent line. This option would be an unusual choice
of final cap style, but is useful in cases where a custom cap will be
added at a later stage or to see where the trace lines end in a given case.

<P> A circular nib traces a line of constant width. This means that the
em-unit and half-span ways of specifying a Join Limit or Extend Cap length
are basically equivalent: for every value expressed one way there is a
value expressed the other way that has the same effect. With other nibs the
width of the curve varies by angle, so the two ways are not equivalent.
In the case of Extend Cap, the cap width is defined as the span of the
nib at the end angle—that is, the width of the nib when it is rotated by that
angle. For Join Limit the "Nib Span" is defined—somewhat artificially—as the
average of the nib spans at the starting and ending angles of the join.  The
result is that when using Width/Span-relative values the result will tend
to scale with the stroke width at the join or cap.

<H2 id="parameters">Other Parameters</H2>

<P> The remaining Expand Stroke parameters have default values that work well
for most cases, but you may need or want to change them in more unusual
cases or when you encounter problems.

<H3>Accuracy Target</H3>

<P> The "Accuracy Target" is specified in em-units and influences the geometric
accuracy of the output.  The algorithms generally "try" to be at least as
accurate as the target but there can be exceptions. The default of 0.25 is a
reasonable choice even you plan to round-to-integer later, although a value of
1 or even higher may well depending on your needs. Given that the Expand
Stroke algorithms are generally fast, the benefit of lower accuracy is not
speed but fewer points/splines in the output.

<H3>Remove Overlap</H3>

<P> The core algorithm of Expand Stroke calculates the "generalized offset
curves" of the source contour and the nib. Its output can therefore include
"cusps" and other artifacts of offsetting. These are typically removed by
passing the initial output through the Remove Overlap algorithm. By default
Remove Overlap is run on the whole layer, but you can also choose to run it
independently on the output of each source contour.

<P> The third option is to skip the Remove Overlap pass entirely. This option
is provided mostly for debugging purposes. In rare cases the Remove Overlap
algorithm may fail or produce inaccurate results. If you run into problems
it can therefore be helpful to "undo" and run Expand Stroke again without
Remove Overlap to see what the problem might be. (And you may be able to fix
the problem area by hand and then run Remove Overlap on the rest, and get your
output without having to wait for a software fix.)

<H3>Remove Internal and Remove External</H3>

<P> As noted above a closed source contour will typically yield a larger
contour enclosing a smaller one. The Remove Internal and Remove External
options allow the user to choose one of the two contours produced in this way.
However, the options names are somewhat misleading. They are accurate in the
case of a <em>clockwise source</em> contour: when Remove Internal is checked
only the larger, outer, clockwise contour is returned while when Remove Internal
is checked only the smaller, inner, counterclockwise contour is returned. When
tracing a <em>counterclockwise source</em> contour, the two options have the
opposite effect.

<P> As a result, when offsetting a typical "o" (for example), choosing Remove
Internal will keep the larger clockwise counterpart of the glyph's larger
clockwise contour and the smaller counterclockwise counterpart of the glyph's
smaller counterclockwise contour. This increases the "weight" of the character
by <em>2r</em>—the diameter of the nib. Choosing Remove External analogously
decreases the weight by <em>2r</em>, assuming it is thicker than that at all
points. (FontForge's Change Weight facility uses Expand Stroke with these
options.)

<H3>Add Extrema and Simplify</H3>

<P> It is normally desirable to avoid mid-spline extrema and to remove unneeded
on-curve points and (in the case of straight lines) unneeded control points.
Therefore Expand Stroke normally runs FontForge's Add Extrema and Simplify
algorithms on its output (in that order). You can change this behavior by
changing these options. One reason to do this is if you prefer a different
choice of Simplify parameters. Expand Stroke uses the Accuracy Target as the
Simplify error parameter, but the other parameters are hard-coded and may
change over time.

</DIV>
</BODY>
</HTML>
