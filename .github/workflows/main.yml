name: CI
on:
  push:
    branches: [ master, releases/** ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# Temporary simplified workflow for testing MSVC Python wheel compatibility
# Builds Python modules only (no GUI) on Linux, macOS, and Windows (MSVC)

jobs:
  linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build gettext libfreetype-dev libglib2.0-dev libxml2-dev zlib1g-dev
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_GUI=OFF \
            -DENABLE_PYTHON_SCRIPTING=ON \
            -DENABLE_PYTHON_EXTENSION=ON \
            -DENABLE_LIBSPIRO=OFF \
            -DENABLE_WOFF2=OFF \
            -DENABLE_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON
      - name: Build
        run: cmake --build build
      - name: Run tests
        run: ctest --test-dir build --output-on-failure
      - name: Run pyhook smoke test
        run: |
          PYTHONPATH=build/lib python3 tests/pyhook_smoketest.py

  mac:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          brew install ninja gettext freetype glib libxml2
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$(brew --prefix gettext)/lib/pkgconfig" >> $GITHUB_ENV
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_FIND_ROOT_PATH="$(brew --prefix gettext)" \
            -DENABLE_GUI=OFF \
            -DENABLE_PYTHON_SCRIPTING=ON \
            -DENABLE_PYTHON_EXTENSION=ON \
            -DENABLE_LIBSPIRO=OFF \
            -DENABLE_WOFF2=OFF \
            -DENABLE_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON
      - name: Build
        run: cmake --build build
      - name: Run tests
        run: ctest --test-dir build --output-on-failure
      - name: Run pyhook smoke test
        run: |
          PYTHONPATH=build/lib python3 tests/pyhook_smoketest.py

  windows-msvc:
    runs-on: windows-latest
    env:
      VCPKG_BINARY_SOURCES: "clear;files,${{ github.workspace }}/vcpkg-cache,readwrite"
    steps:
      - uses: actions/checkout@v4
      - name: Restore vcpkg binary cache
        id: vcpkg-cache
        uses: actions/cache/restore@v4
        with:
          path: vcpkg-cache
          key: vcpkg-files-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: |
            vcpkg-files-${{ runner.os }}-
      - name: Create vcpkg cache directory
        run: New-Item -ItemType Directory -Force -Path vcpkg-cache
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'vcpkg.json'
      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Configure
        run: |
          cmake -B build -G "NMake Makefiles" `
            -DCMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" `
            -DCMAKE_BUILD_TYPE=Release `
            -DENABLE_GUI=OFF `
            -DENABLE_PYTHON_SCRIPTING=ON `
            -DENABLE_PYTHON_EXTENSION=ON `
            -DENABLE_LIBSPIRO=OFF `
            -DENABLE_WOFF2=OFF `
            -DENABLE_DOCS=OFF `
            -DBUILD_SHARED_LIBS=ON
      - name: Build
        run: cmake --build build
      - name: Run pyhook smoke test
        run: |
          # Copy DLLs to lib directory so Python can find them
          Copy-Item build\bin\*.dll build\lib\ -Force
          Copy-Item build\vcpkg_installed\x64-windows\bin\*.dll build\lib\ -Force -ErrorAction SilentlyContinue
          $env:PYTHONPATH = "build\lib"
          python tests/pyhook_smoketest.py
      - name: Save vcpkg binary cache
        if: always()
        uses: actions/cache/save@v4
        with:
          path: vcpkg-cache
          key: vcpkg-files-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
