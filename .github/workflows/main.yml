name: CI
on:
  push:
    branches: [ master, releases/** ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# Temporary workflow for debugging Mac Python module crash
# Only runs Mac build to speed up iteration

jobs:
  mac:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          brew install ninja gettext freetype glib libxml2
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$(brew --prefix gettext)/lib/pkgconfig" >> $GITHUB_ENV
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_FIND_ROOT_PATH="$(brew --prefix gettext)" \
            -DENABLE_GUI=OFF \
            -DENABLE_PYTHON_SCRIPTING=ON \
            -DENABLE_PYTHON_EXTENSION=ON \
            -DENABLE_LIBSPIRO=OFF \
            -DENABLE_WOFF2=OFF \
            -DENABLE_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON
      - name: Build
        run: cmake --build build
      - name: Run tests
        run: ctest --test-dir build --output-on-failure
      - name: Debug - Show library dependencies
        run: |
          echo "=== fontforge.so dependencies ==="
          otool -L build/lib/fontforge*.so || true
          echo "=== psMat.so dependencies ==="
          otool -L build/lib/psMat*.so || true
      - name: Debug - Try minimal import
        run: |
          cd build/lib
          python3 -c "
          import sys
          print('Python:', sys.executable)
          print('Path:', sys.path)
          print('Attempting import...')
          sys.stdout.flush()
          import fontforge
          print('Import succeeded!')
          print('Version:', fontforge.__version__)
          " 2>&1 || echo "Import failed with exit code $?"
      - name: Run pyhook smoke test
        run: |
          PYTHONPATH=build/lib python3 tests/pyhook_smoketest.py
