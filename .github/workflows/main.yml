name: CI
on:
  push:
    branches: [ master, releases/** ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# Temporary workflow for debugging Mac Python module crash
# Only runs Mac build to speed up iteration

jobs:
  mac:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          brew install ninja gettext freetype glib libxml2
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$(brew --prefix gettext)/lib/pkgconfig" >> $GITHUB_ENV
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_FIND_ROOT_PATH="$(brew --prefix gettext)" \
            -DENABLE_GUI=OFF \
            -DENABLE_PYTHON_SCRIPTING=ON \
            -DENABLE_PYTHON_EXTENSION=ON \
            -DENABLE_LIBSPIRO=OFF \
            -DENABLE_WOFF2=OFF \
            -DENABLE_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON
      - name: Build
        run: cmake --build build
      - name: Run tests
        run: ctest --test-dir build --output-on-failure
      - name: Debug - Show library dependencies
        run: |
          echo "=== fontforge.so dependencies ==="
          otool -L build/lib/fontforge*.so || true
          echo "=== psMat.so dependencies ==="
          otool -L build/lib/psMat*.so || true
      - name: Debug - Check Python state
        run: |
          cd build/lib
          # Check if the issue is with how Python loads the module
          python3 << 'PYEOF'
          import sys
          import ctypes

          print("=== Python State Check ===")
          print(f"Python: {sys.executable}")
          print(f"Version: {sys.version}")
          print(f"Platform: {sys.platform}")

          # Check thread state
          import _thread
          print(f"Thread ID: {_thread.get_ident()}")

          # Try to check interpreter state
          print("\n=== Attempting import ===")
          sys.stdout.flush()

          try:
              import fontforge
              print("SUCCESS: fontforge imported")
              print(f"Version: {fontforge.__version__}")
          except Exception as e:
              print(f"EXCEPTION: {type(e).__name__}: {e}")
          PYEOF
      - name: Debug - Run with lldb for stack trace
        run: |
          cd build/lib
          # Create lldb command file that waits for crash
          cat > /tmp/lldb_cmds << 'EOF'
          process handle SIGSEGV --stop true --notify true
          run
          continue
          bt all
          quit
          EOF
          echo "=== Running under lldb ==="
          lldb -b -s /tmp/lldb_cmds -- python3 -c "import fontforge" 2>&1 || true
      - name: Run pyhook smoke test
        run: |
          PYTHONPATH=build/lib python3 tests/pyhook_smoketest.py
