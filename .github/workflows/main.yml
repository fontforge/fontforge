name: CI
on:
  push:
    branches: [ master, releases/** ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

# Temporary workflow for debugging Mac Python module crash
# Only runs Mac build to speed up iteration

jobs:
  mac:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          brew install ninja gettext freetype glib libxml2
          echo "PKG_CONFIG_PATH=$(brew --prefix)/lib/pkgconfig:$(brew --prefix gettext)/lib/pkgconfig" >> $GITHUB_ENV
      - name: Configure
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_FIND_ROOT_PATH="$(brew --prefix gettext)" \
            -DENABLE_GUI=OFF \
            -DENABLE_PYTHON_SCRIPTING=ON \
            -DENABLE_PYTHON_EXTENSION=ON \
            -DENABLE_LIBSPIRO=OFF \
            -DENABLE_WOFF2=OFF \
            -DENABLE_DOCS=OFF \
            -DBUILD_SHARED_LIBS=ON
      - name: Build
        run: cmake --build build
      - name: Run tests
        run: ctest --test-dir build --output-on-failure
      - name: Debug - Show library dependencies
        run: |
          echo "=== fontforge.so dependencies ==="
          otool -L build/lib/fontforge*.so || true
          echo "=== psMat.so dependencies ==="
          otool -L build/lib/psMat*.so || true
      - name: Debug - Try minimal import with crash report
        run: |
          cd build/lib
          # Enable crash reporting
          export MallocStackLogging=1
          # Try import and capture any crash
          python3 -c "
          import sys
          import faulthandler
          faulthandler.enable()
          print('Python:', sys.executable)
          print('Attempting import...')
          sys.stdout.flush()
          import fontforge
          print('Import succeeded!')
          print('Version:', fontforge.__version__)
          " 2>&1 || {
            echo "=== Import crashed with exit code $? ==="
            echo "=== Checking for crash reports ==="
            ls -la ~/Library/Logs/DiagnosticReports/ 2>/dev/null || true
            cat ~/Library/Logs/DiagnosticReports/python3* 2>/dev/null | tail -100 || true
          }
      - name: Debug - Run with lldb for stack trace
        run: |
          cd build/lib
          # Create lldb command file that waits for crash
          cat > /tmp/lldb_cmds << 'EOF'
          process handle SIGSEGV --stop true --notify true
          run
          continue
          bt all
          quit
          EOF
          echo "=== Running under lldb ==="
          lldb -b -s /tmp/lldb_cmds -- python3 -c "import fontforge" 2>&1 || true
      - name: Run pyhook smoke test
        run: |
          PYTHONPATH=build/lib python3 tests/pyhook_smoketest.py
